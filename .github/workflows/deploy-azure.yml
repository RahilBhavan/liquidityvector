# Azure Deployment Pipeline for Liquidity Vector
# Deploys both API and Web services to Azure Container Apps
#
# Required GitHub Secrets:
#   - AZURE_CREDENTIALS: Azure service principal JSON
#   - AZURE_REGISTRY_URL: e.g., myregistry.azurecr.io
#   - AZURE_REGISTRY_USERNAME: ACR username
#   - AZURE_REGISTRY_PASSWORD: ACR password
#   - NEXT_PUBLIC_GEMINI_API_KEY: Gemini API key
#   - NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID: WalletConnect project ID
#   - PRODUCTION_API_URL: e.g., https://api.rahilbhavan.com

name: Deploy to Azure

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  AZURE_RESOURCE_GROUP: liquidityvector-rg
  AZURE_CONTAINER_ENV: liquidityvector-env
  API_IMAGE_NAME: liquidityvector-api
  WEB_IMAGE_NAME: liquidityvector-web

jobs:
  # ===========================================
  # Job 1: Test
  # ===========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: api/requirements.txt

      - name: Install Python dependencies
        run: |
          cd api
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run Python tests
        run: |
          cd api
          pytest tests/ -v --cov=. --cov-report=xml

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Run TypeScript type check
        run: npx tsc --noEmit

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./api/coverage.xml
          fail_ci_if_error: false

  # ===========================================
  # Job 2: Build API
  # ===========================================
  build-api:
    name: Build API Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.AZURE_REGISTRY_URL }}
          username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.AZURE_REGISTRY_URL }}/${{ env.API_IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./api
          file: ./api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================
  # Job 3: Build Web
  # ===========================================
  build-web:
    name: Build Web Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.AZURE_REGISTRY_URL }}
          username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.AZURE_REGISTRY_URL }}/${{ env.WEB_IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_BACKEND_URL=${{ secrets.PRODUCTION_API_URL }}
            NEXT_PUBLIC_API_BASE_URL=/api/backend
            NEXT_PUBLIC_GEMINI_API_KEY=${{ secrets.NEXT_PUBLIC_GEMINI_API_KEY }}
            NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID=${{ secrets.NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================
  # Job 4: Deploy to Azure
  # ===========================================
  deploy:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: [build-api, build-web]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: ${{ steps.deploy-web.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy API Container App
        id: deploy-api
        run: |
          az containerapp update \
            --name ${{ env.API_IMAGE_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ secrets.AZURE_REGISTRY_URL }}/${{ env.API_IMAGE_NAME }}:${{ github.sha }}

          API_URL=$(az containerapp show \
            --name ${{ env.API_IMAGE_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)

          echo "api-url=https://$API_URL" >> $GITHUB_OUTPUT

      - name: Deploy Web Container App
        id: deploy-web
        run: |
          az containerapp update \
            --name ${{ env.WEB_IMAGE_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ secrets.AZURE_REGISTRY_URL }}/${{ env.WEB_IMAGE_NAME }}:${{ github.sha }}

          WEB_URL=$(az containerapp show \
            --name ${{ env.WEB_IMAGE_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)

          echo "url=https://$WEB_URL" >> $GITHUB_OUTPUT

      - name: Health Check - API
        run: |
          echo "Waiting for API to be ready..."
          sleep 30
          curl -f ${{ steps.deploy-api.outputs.api-url }}/health || exit 1
          echo "API health check passed!"

      - name: Health Check - Web
        run: |
          echo "Waiting for Web to be ready..."
          sleep 15
          curl -f ${{ steps.deploy-web.outputs.url }} || exit 1
          echo "Web health check passed!"

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ steps.deploy-api.outputs.api-url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ steps.deploy-web.outputs.url }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Job 5: Notify (Optional)
  # ===========================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && (github.ref == 'refs/heads/main')
    steps:
      - name: Notify on success
        if: needs.deploy.result == 'success'
        run: |
          echo "Deployment succeeded!"
          # Add Slack/Discord/Teams notification here

      - name: Notify on failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "Deployment failed!"
          # Add Slack/Discord/Teams notification here
